#!/usr/bin/env sh
# path: ~/.config/yabai/yabairc
# description: Neutral base configuration — global behavior ONLY.
#              Layout, padding, gaps, balance, and tree behavior are set by profiles.
#              This file is the equivalent of Spring Boot's application.properties:
#              sensible defaults, zero opinion on layout.
#
# version: yabai v7.1.x | macOS 26.2 Tahoe (M4 Max)
# SIP: Fully enabled — NO scripting addition, NO space manipulation commands.
# date: 2026-02-08
# CHANGELOG: 2026-02-08 | Consolidated SIP-gated settings into honest section —
#              window_shadow, opacity, and animation controls are no-ops with SIP
#              enabled but kept for future-proofing and documentation completeness.
#            2026-02-08 | Moved BSP-specific settings (split_type, window_placement,
#              window_insertion_point, insert_feedback_color) to yabai-bsp.sh profile.
#              Neutral base is now truly layout-agnostic across stack/bsp/float.
#            2026-02-07 | Added explicit opacity defaults for future-proofing.
#            2026-02-04 | Merged Gemini's v7 options, refocus signals, float rules,
#              explicit defaults into Claude's neutral-base architecture.
#            ROLLBACK: Restore 4 BSP lines from yabai-bsp.sh back here if needed.

# ── Global Behavior ──────────────────────────────────────────────

# WHY on: Zoom state (zoom-fullscreen / zoom-parent) survives focus changes.
# Without this, switching focus unzooms your window. v7 feature.
yabai -m config window_zoom_persist          on

# WHY off: Focus changes only on explicit action (click or keybind), not mouse hover.
# Prevents accidental focus shifts when moving mouse to dock/menubar.
yabai -m config mouse_follows_focus          off
yabai -m config focus_follows_mouse          off

# ── SIP-Gated Settings (no-ops while SIP is fully enabled) ───────
# WHY kept: Future-proofing if SIP is ever partially disabled.
# These require the scripting addition to take effect.
# With SIP enabled, yabai silently ignores them — no errors, no effect.
# Stating them explicitly protects against future yabai releases changing
# defaults silently. Same principle as Spring Boot's server.port=8080.

# Shadow control — requires scripting addition.
yabai -m config window_shadow                float

# Animation control — requires Screen Recording permission AND scripting addition.
yabai -m config window_animation_duration    0.0
yabai -m config window_animation_easing      ease_out_circ

# Opacity control — requires scripting addition.
yabai -m config window_opacity               off
yabai -m config window_opacity_duration      0.0
yabai -m config active_window_opacity        1.0
yabai -m config normal_window_opacity        0.90

# ── Explicit Defaults (non-SIP-gated) ────────────────────────────

yabai -m config external_bar                 off:0:0
yabai -m config menubar_opacity              1.0

# ── Mouse Interaction ────────────────────────────────────────────

# WHY ctrl: On HHKB, Ctrl is home-row left — comfortable for modifier+click.
# Hold modifier + left-click to move, + right-click to resize.
yabai -m config mouse_modifier               ctrl
yabai -m config mouse_action1                move
yabai -m config mouse_action2                resize

# WHY swap: Dragging a window onto another swaps positions (not stack).
# Stack behavior is managed by profile/keybinds, not mouse.
yabai -m config mouse_drop_action            swap

# ── Display Handling ─────────────────────────────────────────────

# WHY default: Respect macOS display arrangement from System Settings.
yabai -m config window_origin_display        default
yabai -m config display_arrangement_order    default

# ── Signals ──────────────────────────────────────────────────────

# WHY: When external displays connect/disconnect, yabai needs to re-read geometry.
# Restart service to cleanly re-tile all windows for the new display config.
yabai -m signal --add event=display_added   action="yabai --restart-service"
yabai -m signal --add event=display_removed action="yabai --restart-service"

# WHY refocus: When a window is destroyed/minimized/hidden, focus the most recent
# window so you're never left staring at nothing. Critical for stack mode where
# closing the top window would leave the entire screen blank without this.
yabai -m signal --add event=window_destroyed  active=yes action="yabai -m query --windows --window &> /dev/null || yabai -m window --focus recent"
yabai -m signal --add event=window_minimized  active=yes action="yabai -m window --focus recent"
yabai -m signal --add event=application_hidden active=yes action="yabai -m window --focus recent"

# ── Float Rules ──────────────────────────────────────────────────
# WHY: System apps and dialogs should never be tiled. They break layouts
# and confuse the BSP tree. Manage=off tells yabai to leave them alone.
#
# Pattern: Combine related apps into single regex where possible (rafi pattern).
# Use anchored regex (^ and $) for exact matching — avoids false positives.

# macOS System Apps — never tile
yabai -m rule --add app="^(System Settings|System Information|System Preferences)$" manage=off
yabai -m rule --add app="^(Activity Monitor|Disk Utility|Console|Migration Assistant)$" manage=off
yabai -m rule --add app="^(Calculator|Font Book|Keychain Access|Screenshot)$" manage=off
yabai -m rule --add app="^(Audio MIDI Setup|ColorSync Utility|VoiceOver Utility)$" manage=off
yabai -m rule --add app="^(Bluetooth File Exchange|Digital Color Meter|Grapher)$" manage=off

# Media & Communication — float by default
yabai -m rule --add app="^(FaceTime|Photo Booth|QuickTime Player|Preview)$" manage=off

# Karabiner — prefix match catches both Elements and EventViewer
yabai -m rule --add app="^Karabiner-" manage=off

# Ghostty — float popup/quick terminal windows (subrole identifies overlay panels)
yabai -m rule --add app="^Ghostty$" subrole="AXFloatingWindow" manage=off

# Docker Desktop — float (dashboard UI, not a coding window)
yabai -m rule --add app="^Docker Desktop$" manage=off

# macOS Installer — transient
yabai -m rule --add app="^Installer$" manage=off

# Development Tools — float dialogs/simulators
yabai -m rule --add app="^Simulator$" manage=off

# Finder — only float info/preferences windows, tile normal Finder windows
yabai -m rule --add app="^Finder$" title="(Co(py|nnect)|Move|Info|Pref)" manage=off

# App Store & Software Update — float (modal-heavy, tiling breaks them)
yabai -m rule --add app="^(App Store|Software Update)$" manage=off

# Archive utilities — transient windows
yabai -m rule --add app="^(Archive Utility|Keka)$" manage=off

# ── Apply Rules Retroactively ────────────────────────────────────
# WHY: Since yabai v7, rules only apply to NEW windows by default.
# This restores the old behavior: apply rules to already-open windows too.
yabai -m rule --apply

# ── Debug ────────────────────────────────────────────────────────
# Uncomment to enable debug logging (check: tail -f /tmp/yabai_$USER.err.log)
# yabai -m config debug_output on

echo "yabai: neutral base loaded (no layout — apply a profile)"

