#!/usr/bin/env sh
# path: ~/.config/yabai/yabairc
# description: Neutral base configuration — global behavior ONLY.
#              Layout, padding, gaps, and balance are set by profiles.
#              This file is the equivalent of Spring Boot's application.properties:
#              sensible defaults, zero opinion on layout.
#
# version: yabai v7.1.x | macOS 26.2 Tahoe (M4 Max)
# SIP: Fully enabled — NO scripting addition, NO space manipulation commands.
# date: 2026-02-07
# CHANGELOG: 2026-02-07 | Merged Gemini's v7 options, refocus signals, float rules,
#              explicit defaults into Claude's neutral-base architecture.
#            ROLLBACK: Revert to pre-merge yabairc (see git history)

# ── Global Behavior ──────────────────────────────────────────────

# WHY second_child: New windows appear right/below, matching natural reading flow.
yabai -m config window_placement             second_child

# WHY auto: yabai picks vertical or horizontal split based on window dimensions.
# Wide windows split vertically, tall windows split horizontally. v7 feature.
yabai -m config split_type                   auto

# WHY focused: New windows split at the focused window, not the tree root.
# More intuitive — the split happens where your eyes already are.
yabai -m config window_insertion_point        focused

# WHY on: Zoom state (zoom-fullscreen / zoom-parent) survives focus changes.
# Without this, switching focus unzooms your window. v7 feature.
yabai -m config window_zoom_persist          on

# WHY off: Focus changes only on explicit action (click or keybind), not mouse hover.
# Prevents accidental focus shifts when moving mouse to dock/menubar.
yabai -m config mouse_follows_focus          off
yabai -m config focus_follows_mouse          off

# WHY float: Shadows only on floating windows — tiled windows don't need depth cues.
yabai -m config window_shadow                float

# WHY 0.0: Disable animations entirely for snappy response.
# NOTE: window_animation_duration requires Screen Recording permission if > 0.
yabai -m config window_animation_duration    0.0
# WHY preset: If you ever enable animations, ease_out_circ gives smooth deceleration.
yabai -m config window_animation_easing      ease_out_circ

# WHY explicit: Visual hint showing where a new window will land in BSP tree.
# Warm red — visible without being distracting. Only appears during insertion.
yabai -m config insert_feedback_color        0xffd75f5f

# ── Explicit Defaults (future-proof against yabai changing these) ─

# WHY explicit: These ARE the current defaults, but stating them protects against
# future yabai releases changing defaults silently. Same principle as Spring Boot
# explicitly declaring server.port=8080.
yabai -m config window_opacity               off
yabai -m config external_bar                 off:0:0
yabai -m config menubar_opacity              1.0

# ── Mouse Interaction ────────────────────────────────────────────

# WHY ctrl: On HHKB, Ctrl is home-row left — comfortable for modifier+click.
# Hold modifier + left-click to move, + right-click to resize.
yabai -m config mouse_modifier               ctrl
yabai -m config mouse_action1                move
yabai -m config mouse_action2                resize

# WHY swap: Dragging a window onto another swaps positions (not stack).
# Stack behavior is managed by profile/keybinds, not mouse.
yabai -m config mouse_drop_action            swap

# ── Display Handling ─────────────────────────────────────────────

# WHY default: Respect macOS display arrangement from System Settings.
yabai -m config window_origin_display        default
yabai -m config display_arrangement_order    default

# ── Signals ──────────────────────────────────────────────────────

# WHY: When external displays connect/disconnect, yabai needs to re-read geometry.
# Restart service to cleanly re-tile all windows for the new display config.
yabai -m signal --add event=display_added   action="yabai --restart-service"
yabai -m signal --add event=display_removed action="yabai --restart-service"

# WHY refocus: When a window is destroyed/minimized/hidden, focus the most recent
# window so you're never left staring at nothing. Critical for stack mode where
# closing the top window would leave the entire screen blank without this.
yabai -m signal --add event=window_destroyed  active=yes action="yabai -m query --windows --window &> /dev/null || yabai -m window --focus recent"
yabai -m signal --add event=window_minimized  active=yes action="yabai -m window --focus recent"
yabai -m signal --add event=application_hidden active=yes action="yabai -m window --focus recent"

# ── Float Rules ──────────────────────────────────────────────────
# WHY: System apps and dialogs should never be tiled. They break layouts
# and confuse the BSP tree. Manage=off tells yabai to leave them alone.
#
# Pattern: Combine related apps into single regex where possible (rafi pattern).
# Use anchored regex (^ and $) for exact matching — avoids false positives.

# macOS System Apps — never tile
yabai -m rule --add app="^(System Settings|System Information|System Preferences)$" manage=off
yabai -m rule --add app="^(Activity Monitor|Disk Utility|Console|Migration Assistant)$" manage=off
yabai -m rule --add app="^(Calculator|Font Book|Keychain Access|Screenshot)$" manage=off
yabai -m rule --add app="^(Audio MIDI Setup|ColorSync Utility|VoiceOver Utility)$" manage=off
yabai -m rule --add app="^(Bluetooth File Exchange|Digital Color Meter|Grapher)$" manage=off

# Media & Communication — float by default
yabai -m rule --add app="^(FaceTime|Photo Booth|QuickTime Player|Preview)$" manage=off

# Karabiner — prefix match catches both Elements and EventViewer
yabai -m rule --add app="^Karabiner-" manage=off

# Ghostty — float popup/quick terminal windows (subrole identifies overlay panels)
yabai -m rule --add app="^Ghostty$" subrole="AXFloatingWindow" manage=off

# Docker Desktop — float (dashboard UI, not a coding window)
yabai -m rule --add app="^Docker Desktop$" manage=off

# macOS Installer — transient
yabai -m rule --add app="^Installer$" manage=off

# Development Tools — float dialogs/simulators
yabai -m rule --add app="^Simulator$" manage=off

# Finder — only float info/preferences windows, tile normal Finder windows
yabai -m rule --add app="^Finder$" title="(Co(py|nnect)|Move|Info|Pref)" manage=off

# App Store & Software Update — float (modal-heavy, tiling breaks them)
yabai -m rule --add app="^(App Store|Software Update)$" manage=off

# Archive utilities — transient windows
yabai -m rule --add app="^(Archive Utility|Keka)$" manage=off

# ── Apply Rules Retroactively ────────────────────────────────────
# WHY: Since yabai v7, rules only apply to NEW windows by default.
# This restores the old behavior: apply rules to already-open windows too.
yabai -m rule --apply

# ── Debug ────────────────────────────────────────────────────────
# Uncomment to enable debug logging (check: tail -f /tmp/yabai_$USER.err.log)
# yabai -m config debug_output on

echo "yabai: neutral base loaded (no layout — apply a profile)"

