# ╔══════════════════════════════════════════════════════════════════════╗
# ║  tmux.conf — PDE Multiplexer Layer                                 ║
# ║  path: ~/.config/tmux/tmux.conf                                    ║
# ║  tmux 3.6a · Ghostty · M4 Max · HHKB Type-S                       ║
# ╚══════════════════════════════════════════════════════════════════════╝
#
# ARCHITECTURE:
#   macOS Desktop (yabai)  →  macro spatial layer (which app where)
#   tmux                   →  micro spatial layer (sessions/windows/panes inside Ghostty)
#   Neovim                 →  innermost layer (splits/buffers inside one tmux pane)
#
# PREFIX:
#   C-b (default, unchanged) — physically pressed as Cmd+z via Ghostty keybind.
#   Ghostty config: keybind = cmd+z=text:\x02
#   This is years of muscle memory. Do not change.
#
# CHANGELOG:
#   2026-02-06 | Initial build from scratch | ROLLBACK: Delete this file


# ── Server Options ──────────────────────────────────────────────────────

# WHY: Neovim :checkhealth demands this. Without it, Esc in Neovim has
# a 500ms delay (tmux default) because tmux waits to see if Esc is part
# of a Meta key sequence. 0 = instant. Neovim is unusable without this.
set -s escape-time 0

# WHY: Enables 24-bit true color. tmux-256color tells programs inside
# tmux that 256 colors + italics + true color are available.
# Ghostty's TERM is xterm-ghostty but tmux needs its own TERM value.
set -s default-terminal "tmux-256color"

# WHY: RGB true color passthrough. Tells tmux that these terminal types
# support 24-bit RGB color. Covers Ghostty, Alacritty, and screen.
# Without this: Neovim/colorscheme colors are wrong inside tmux.
set -sa terminal-overrides ",alacritty:Tc,xterm-256color:Tc,xterm*:Tc,screen-256color:Tc"

# WHY: Neovim autocommands (FocusGained/FocusLost) need this to fire.
# Powers auto-save, auto-reload, and gitgutter refresh on focus change.
set -s focus-events on

# WHY: Extended keys let tmux recognize C-1, C-;, and other combos that
# traditional terminals can't distinguish. tmux 3.2+ feature.
set -s extended-keys on


# ── Session Options ─────────────────────────────────────────────────────

# WHY: Keyboards start at 1, not 0. Reaching for 0 on HHKB is awkward.
# Window 1 is leftmost in status bar, mapped to key 1. Natural.
set -g base-index 1

# WHY: Same reasoning as base-index but for panes. Pane 1 = first pane.
set -g pane-base-index 1

# WHY: When a window is closed, remaining windows renumber to fill gaps.
# Prevents window list from becoming 1, 3, 7 after closing windows.
set -g renumber-windows on

# WHY: 50k lines of scrollback. Generous for log tailing and debugging.
# RAM is abundant on M4 Max. Default 2000 is too low for real work.
set -g history-limit 50000

# WHY: Messages and pane numbers stay visible longer.
# Default 750ms is too fast to read. 3 seconds is comfortable.
set -g display-time 3000
set -g display-panes-time 3000

# WHY: Mouse support for pane selection, resize, and scroll.
# Does not replace keyboard workflow — supplements it for quick actions.
set -g mouse on

# WHY: vi keybindings for copy mode and command prompt.
# Consistent with Neovim muscle memory. No emacs bindings in PDE.
set -g mode-keys vi
set -g status-keys vi

# WHY: Activity monitoring. When a background window has output,
# mark it in the status bar so you know something happened.
set -g monitor-activity on
set -g visual-activity off       # Status flag only, no disruptive message

# WHY: Suppress bell entirely. Fish shell sends bell on failed tab-completion
# and empty-prompt backspace. The bell-style highlight is ugly and distracting.
set -g bell-action none
set -g visual-bell off

# WHY: Don't let programs (like shells) rename windows automatically.
# Session windows are named intentionally — names should stick.
set -g allow-rename off

# WHY: Enable OSC 52 clipboard. This lets tmux copy to the system
# clipboard through the terminal (Ghostty supports this natively).
# "on" = tmux both sets and gets the clipboard via OSC 52.
set -g set-clipboard on


# ── Keybindings ─────────────────────────────────────────────────────────
# PHILOSOPHY:
#   - Prefix (C-b / Cmd+z) for tmux commands
#   - <C-hjkl> in root table for seamless nvim↔tmux navigation
#   - <M-hjkl> is Neovim-exclusive (window resize) — tmux does NOT use it
#   - Visual mnemonics: | for vertical split, - for horizontal split

# ── Reload config ──
# WHY: Fast iteration. Reload without restarting tmux server.
bind r source-file ~/.config/tmux/tmux.conf \; display "Config reloaded"

# ── Pane Splitting ──
# WHY: Default " and % are not memorable. | looks like a vertical line,
# - looks like a horizontal line. Visual mnemonics.
# pane_current_path: new panes open in the same directory as current pane.
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# ── New Window in Current Path ──
# WHY: t for "tab" — mental model is tabs = windows. Opens in current dir.
unbind t
bind t new-window -c "#{pane_current_path}"

# ── Seamless Navigation: Neovim Splits ↔ tmux Panes ──
# WHY: The most important keybinding decision in the entire PDE.
# <C-hjkl> means "move focus in that direction" EVERYWHERE.
# This detects if the active pane is running Neovim and forwards the key
# to Neovim if so, otherwise does tmux pane navigation.
#
# REQUIRES: Neovim plugin (vim-tmux-navigator or equivalent) in Phase 2.
# Until then, <C-hjkl> does tmux pane navigation only.
#
# Pattern: christoomey/vim-tmux-navigator (battle-tested, universal)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
  | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

bind-key -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind-key -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind-key -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind-key -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# ── Pane Resizing ──
# WHY: Prefix + HJKL (uppercase) for resizing. Logical: lowercase navigates,
# uppercase resizes. 5-cell steps for quick adjustment.
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# ── Window Navigation ──
# WHY: [ and ] are bracket-pair navigation — intuitive for cycling.
# Matches the mental model of "stepping through" a list.
unbind [
bind [ previous-window
unbind ]
bind ] next-window

# WHY: Swap current window left/right in the window list.
# < and > are visual mnemonics for "shift left" and "shift right".
bind -r < swap-window -t -1\; select-window -t -1
bind -r > swap-window -t +1\; select-window -t +1

# ── Session Navigation ──
# WHY: Quick session switching for your workflow (backend/frontend/notes/config).
# Prefix+s already shows session tree (default). These add quick cycling.
bind -r ( switch-client -p    # Previous session
bind -r ) switch-client -n    # Next session

# ── Pane Management ──
# WHY: c for "close" — quick pane kill, no confirmation prompt.
# x is freed up. X for the bigger action (kill whole window).
unbind c
bind c kill-pane
unbind x                      # Remove default kill-pane — c handles this
bind z resize-pane -Z         # Toggle zoom (already default, explicit for clarity)
bind X kill-window            # Kill window (uppercase = more destructive)

# ── Session Rename ──
# WHY: Default , renames window. Sessions matter more in this workflow
# (backend/frontend/notes/config). Rename session, not window.
unbind ','
bind , command-prompt -p "Rename session to:" "rename-session '%%'"

# ── Copy Mode (vi-style) ──
# WHY: Make copy mode feel like Neovim visual mode.
# v starts selection (like visual mode), y yanks (like yank), Escape exits.
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi Escape send-keys -X cancel

# WHY: Enter copy mode with prefix+v (v for visual/view).
# Default prefix+[ is rebound to previous-window, so v is the entry point.
# Paste: use Cmd+V (system clipboard via OSC 52). No tmux paste binding needed.
bind v copy-mode


# ── Status Bar / UI (Theming) ─────────────────────────────────────────
# Palette reference:
#   base=#1a1b26  accent=#7aa2f7  dim=#414868  text=#c0caf5  sub=#565f89
#   neon=#7aa2f7  warn=#f7768e    highlight=#bb9af7  error=#f7768e  success=#9ece6a

# Status bar: transparent background, top-pinned, left-justified
set -g status-style "bg=default,fg=default"
set -g status-position top
set -g status-interval 60
set -g status-justify left

# Pane borders: dim for inactive, accent for active (must be distinguishable for splits)
set -g pane-border-style "fg=#414868"
set -g pane-active-border-style "fg=#7aa2f7,bold"
set -g display-panes-colour "#414868"
set -g display-panes-active-colour "#87a1ee"
set -g pane-border-status off

# Messages / modes / alerts
set -g message-style "bg=#000000,fg=#7aa2f7,bold"
set -g message-command-style "bg=#000000,fg=#7aa2f7,bold"
set -wg mode-style "bg=#565f89,fg=#c0caf5,italics"
set -wg clock-mode-colour "#bb9af7"
set -wg window-status-activity-style "bg=#414868,fg=#9ece6a"

# Window tabs: show directory name, accent on active
set -wg window-status-separator "#[fg=#414868] "
set -wg window-status-current-format "#[fg=#87a1ee,bold] (#{b:pane_current_path})"
set -wg window-status-format "#[fg=#737373](#{b:pane_current_path})"

# Left segment: session badge with prefix/zoom/sync indicators
set -g status-left-length 120
set -g status-left "#[fg=#87a1ee]#{?client_prefix,#[fg=#0bce98,bold],} 󰘍 #S ┊#{?client_prefix, [prefix mode],}#[fg=#ffffff]#{?window_zoomed_flag,  zoom,} #{?pane_synchronized, 󱓷,}"


# Right segment: system metrics + time/date
set -g status-right-length 120
set -g status-right '#[fg=#87a1ee]#($HOME/.config/tmux/scripts/mem-cpu.sh) #[fg=#87a1ee]┊ #[fg=#87a1ee]%I:%M%p %B %d, %Y'


# ── Notes ───────────────────────────────────────────────────────────────
#
# SPLITS PRIMER (you said you never split — here's why you should):
#
#   Prefix + |   →  vertical split (editor left, shell right)
#   Prefix + -   →  horizontal split (editor top, logs bottom)
#   C-h/j/k/l   →  move between splits AND Neovim windows seamlessly
#   Prefix + z   →  zoom any pane to fullscreen, press again to unzoom
#   Prefix + H/J/K/L  →  resize panes
#   Prefix + c   →  kill a pane when done
#
# TYPICAL LAYOUT:
#   ┌──────────────────┬──────────┐
#   │                  │          │
#   │     Neovim       │  shell   │
#   │                  │  or      │
#   │                  │  lazygit │
#   │                  │          │
#   └──────────────────┴──────────┘
#
# You can still use tabs (windows) for separate contexts.
# Splits are for things you want to SEE simultaneously.
# Tabs are for things you want to SWITCH between.
#
# YOUR SESSION WORKFLOW:
#   tmux new -s backend      →  Spring Boot work
#   tmux new -s frontend     →  React/Next.js work
#   tmux new -s notes        →  Documentation/notes
#   tmux new -s config       →  Dotfiles/PDE work
#   Prefix + s               →  Session picker (tree view)
#   Prefix + ( / )           →  Cycle sessions
#
# NEW ADDITIONS (2026-02-06 rebuild):
#   Everything else was already yours. These are the new muscle memories:
#   |  and  -       →  splits (you never split before)
#   C-hjkl          →  seamless navigation (the big unlock)
#   H/J/K/L         →  pane resizing
#   < >             →  reordering windows
#   ( )             →  session cycling
#   v               →  copy mode entry
#   r               →  config reload
